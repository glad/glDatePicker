(function($){$.fn.glDatePicker=function(e){var t="glDatePicker";var n=this.data(t);if(!n){return this.each(function(){return $(this).data(t,new glDatePicker(this,e))})}return e===true?n:this};$.fn.glDatePicker.defaults={cssName:"default",zIndex:1e3,borderSize:1,calendarOffset:{x:0,y:1},showAlways:false,hideOnClick:true,allowMonthSelect:true,allowYearSelect:true,todayDate:new Date,selectedDate:null,prevArrow:"◄",nextArrow:"►",selectableDates:null,selectableDateRange:null,specialDates:null,selectableMonths:null,selectableYears:null,selectableDOW:null,monthNames:null,dowNames:null,dowOffset:0,onClick:function(e,t,n,r){e.val(n.toLocaleDateString())},onHover:function(e,t,n,r){},onShow:function(e){e.show()},onHide:function(e){e.hide()},firstDate:null};var glDatePicker=function(){function glDatePicker(e,t){var n=this;n.el=$(e);var r=n.el;n.options=$.extend(true,{},$.fn.glDatePicker.defaults,t);var i=n.options;n.calendar=$($.find("[gldp-el="+r.attr("gldp-id")+" ]"));i.selectedDate=i.selectedDate||i.todayDate;i.firstDate=(new Date(i.firstDate||i.selectedDate))._first();if(!(r.attr("gldp-id")||"").length){r.attr("gldp-id","gldp-"+Math.round(Math.random()*1e10))}r.addClass("gldp-el").bind("click",function(e){n.show(e)}).bind("focus",function(e){n.show(e)});if(n.calendar.length&&!i.showAlways){n.calendar.hide()}$(document).bind("mouseup",function(e){var t=e.target;var i=n.calendar;if(!r.is(t)&&!i.is(t)&&i.has(t).length===0&&i.is(":visible")){n.hide()}});n.render()}glDatePicker.prototype={show:function(){$.each($(".gldp-el").not(this.el),function(e,t){if(t.length){t.options.onHide(t.calendar)}});this.options.onShow(this.calendar)},hide:function(){if(this.options&&!this.options.showAlways){this.options.onHide(this.calendar)}},render:function(renderCalback){var self=this;var el=self.el;var options=self.options;var calendar=self.calendar;var coreClass=" core border ";var cssName="gldp-"+options.cssName;var todayVal=options.todayDate._val();var todayTime=todayVal.time;var maxRow=6;var maxCol=7;var borderSize=options.borderSize+"px";var getSelectableList=function(e,t,n){var r=[];for(var i=e;i<=t;i++){r.push(i)}if(n){var s=[];$.each(n,function(n,r){if(r>=e&&r<=t&&s._indexOf(r)<0){s.push(r)}});r=s.length?s:r}r.sort();return r};var selectableMonths=getSelectableList(0,11,options.selectableMonths);var selectableYears=getSelectableList(todayVal.year-5,todayVal.year+5,options.selectableYears);var selectableDOW=getSelectableList(0,6,options.selectableDOW);var dowNames=options.dowNames||["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];var monthNames=options.monthNames||["January","February","March","April","May","June","July","August","September","October","November","December"];var containerWidth=el.outerWidth();var containerHeight=containerWidth;var getCellSize=function(e,t){return e/t+options.borderSize/t*(t-1)};var cellWidth=getCellSize(containerWidth,maxCol);var cellHeight=getCellSize(containerHeight,maxRow+2);if(!calendar.length){self.calendar=calendar=$("<div/>").attr("gldp-el",el.attr("gldp-id")).data("is",true).css({display:options.showAlways?undefined:"none",zIndex:options.zIndex,width:cellWidth*maxCol+"px"});options.container?options.container.append(calendar):$("body").append(calendar)}else{if(!eval(calendar.data("is"))){containerWidth=calendar.outerWidth();containerHeight=calendar.outerHeight();cellWidth=getCellSize(containerWidth,maxCol);cellHeight=getCellSize(containerHeight,maxRow+2)}}if(!el.is(":visible")){calendar.hide()}calendar.removeClass().addClass(cssName).children().remove();var onResize=function(){var e=el.offset();calendar.css({top:e.top+el.outerHeight()+options.calendarOffset.y+"px",left:e.left+options.calendarOffset.x+"px"})};$(window).resize(onResize);onResize();var cellCSS={width:cellWidth+"px",height:cellHeight+"px",lineHeight:cellHeight+"px"};var setFirstDate=function(e){if(e){options.firstDate=e;self.render()}};var getFirstDate=function(e){var t=new Date(options.firstDate);e=e||0;while(true){t.setMonth(t.getMonth()+e);t.setDate(Math.min(1,t._max()));if(e==0){break}var n=t._val();var r=n.month;var i=n.year;if(selectableMonths._indexOf(r)!=-1){if(selectableYears._indexOf(i)!=-1){break}else{if(i<selectableYears[0]||i>selectableYears[selectableYears.length-1]){return null}}}}return t};var prevFirstDate=getFirstDate(-1);var nextFirstDate=getFirstDate(1);var firstDate=options.firstDate=getFirstDate();var firstDateVal=firstDate._val();var firstDateMonth=firstDateVal.month;var firstDateYear=firstDateVal.year;var startDate=new Date(firstDate);var dowOffset=Math.abs(Math.min(6,Math.max(0,options.dowOffset)));var startOffset=startDate.getDay()-dowOffset;startOffset=startOffset<1?-7-startOffset:-startOffset;dowNames=dowNames.concat(dowNames).slice(dowOffset,dowOffset+7);startDate._add(startOffset);var showPrev=prevFirstDate;var showNext=nextFirstDate;var monyearClass=coreClass+"monyear ";var prevCell=$("<div/>").addClass(monyearClass).css($.extend({},cellCSS,{borderWidth:borderSize+" 0 0 "+borderSize})).append($("<a/>").addClass("prev-arrow"+(showPrev?"":"-off")).html(options.prevArrow)).mousedown(function(){return false}).click(function(e){if(options.prevArrow!=""&&showPrev){e.stopPropagation();setFirstDate(prevFirstDate)}});var titleCellCount=maxCol-2;var titleWidth=cellWidth*titleCellCount-titleCellCount*options.borderSize+options.borderSize;var titleCell=$("<div/>").addClass(monyearClass+"title").css($.extend({},cellCSS,{width:titleWidth+"px",borderTopWidth:borderSize,marginLeft:"-"+borderSize}));var nextCell=$("<div/>").addClass(monyearClass).css($.extend({},cellCSS,{marginLeft:"-"+borderSize,borderWidth:borderSize+" "+borderSize+" 0 0"})).append($("<a/>").addClass("next-arrow"+(showNext?"":"-off")).html(options.nextArrow)).mousedown(function(){return false}).click(function(e){if(options.nextArrow!=""&&showNext){e.stopPropagation();setFirstDate(nextFirstDate)}});calendar.append(prevCell).append(titleCell).append(nextCell);for(var row=0,cellIndex=0;row<maxRow+1;row++){for(var col=0;col<maxCol;col++,cellIndex++){var cellDate=new Date(startDate);var cellClass="day";var cellZIndex=options.zIndex+cellIndex;var cell=$("<div/>");if(!row){cellClass="dow";cell.html(dowNames[col]);cellDate=null}else{cellDate._add(col+(row-1)*maxCol);var cellDateVal=cellDate._val();var cellDateTime=cellDateVal.time;var specialData=null;var isSelectable=true;var getRepeatDate=function(e,t){if(e.repeatYear===true){t.setYear(cellDateVal.year)}if(e.repeatMonth===true){t.setMonth(cellDateVal.month)}return t._val()};cell.html(cellDateVal.date);if(options.selectableDateRange){isSelectable=false;$.each(options.selectableDateRange,function(e,t){var n=t.from;var r=t.to||null;r=r||new Date(t.from.getFullYear(),t.from.getMonth(),t.from._max());n=getRepeatDate(t,n);r=getRepeatDate(t,r);if(cellDateTime>=n.time&&cellDateTime<=r.time){isSelectable=true;return true}})}if(options.selectableDates){if(options.selectableDateRange&&!isSelectable||isSelectable&&!options.selectableDateRange){isSelectable=false}$.each(options.selectableDates,function(e,t){var n=getRepeatDate(t,t.date);if(n.time==cellDateTime){return isSelectable=true}})}if(!isSelectable||selectableYears._indexOf(cellDateVal.year)<0||selectableMonths._indexOf(cellDateVal.month)<0||selectableDOW._indexOf(cellDateVal.day)<0){cellClass="noday"}else{cellClass=["sun","mon","tue","wed","thu","fri","sat"][cellDateVal.day];if(firstDateMonth!=cellDateVal.month){cellClass+=" outday"}if(todayTime==cellDateTime){cellClass="today";cellZIndex+=50}if(options.selectedDate._time()==cellDateTime){cellClass="selected";cellZIndex+=51}if(options.specialDates){$.each(options.specialDates,function(e,t){var n=getRepeatDate(t,t.date);if(n.time==cellDateTime){cellClass=t.cssClass||"special";cellZIndex+=52;specialData=t.data}})}cell.mousedown(function(){return false}).hover(function(e){e.stopPropagation();var t=$(this).data("data");options.onHover(el,cell,t.date,t.data)}).click(function(e){e.stopPropagation();var t=$(this).data("data");options.selectedDate=options.firstDate=t.date;self.render(function(){if(!options.showAlways&&options.hideOnClick){self.hide()}});options.onClick(el,$(this),t.date,t.data)})}}$.extend(cellCSS,{borderTopWidth:borderSize,borderBottomWidth:borderSize,borderLeftWidth:row>0||!row&&!col?borderSize:0,borderRightWidth:row>0||!row&&col==6?borderSize:0,marginLeft:col>0?"-"+borderSize:0,marginTop:row>0?"-"+borderSize:0,zIndex:cellZIndex});cell.data("data",{date:cellDate,data:specialData}).addClass(coreClass+cellClass).css(cellCSS);calendar.append(cell)}}var toggleYearMonthSelect=function(e){var t="inline-block";var n="none";if(options.allowMonthSelect){monthText.css({display:!e?n:t});monthSelect.css({display:!e?t:n})}if(options.allowYearSelect){yearText.css({display:e?n:t});yearSelect.css({display:e?t:n})}};var onYearMonthSelect=function(){options.firstDate=new Date(yearSelect.val(),monthSelect.val(),1);self.render()};var monthSelect=$("<select/>").hide().change(onYearMonthSelect);var yearSelect=$("<select/>").hide().change(onYearMonthSelect);var monthText=$("<span/>").html(monthNames[firstDateMonth]).mousedown(function(){return false}).click(function(e){e.stopPropagation();toggleYearMonthSelect(false)});var yearText=$("<span/>").html(firstDateYear).mousedown(function(){return false}).click(function(e){e.stopPropagation();toggleYearMonthSelect(true)});$.each(monthNames,function(e,t){if(options.allowMonthSelect&&selectableMonths._indexOf(e)!=-1){var n=$("<option/>").html(t).attr("value",e);if(e==firstDateMonth){n.attr("selected","selected")}monthSelect.append(n)}});$.each(selectableYears,function(e,t){if(options.allowYearSelect){var n=$("<option/>").html(t).attr("value",t);if(t==firstDateYear){n.attr("selected","selected")}yearSelect.append(n)}});var titleYearMonth=$("<div/>").append(monthText).append(monthSelect).append(yearText).append(yearSelect);titleCell.children().remove();titleCell.append(titleYearMonth);renderCalback=renderCalback||function(){};renderCalback();if(typeof options.onRender=="function"){options.onRender(options.firstDate)}}};return glDatePicker}();(function(){Date.prototype._clear=function(){this.setHours(0);this.setMinutes(0);this.setSeconds(0);this.setMilliseconds(0);return this};Date.prototype._time=function(){return this._clear().getTime()};Date.prototype._max=function(){var e=(new Date(this.getYear(),1,29)).getMonth()==1?1:0;var t=[31,28+e,31,30,31,30,31,31,30,31,30,31];return t[this.getMonth()]};Date.prototype._add=function(e){this.setDate(this.getDate()+e)};Date.prototype._first=function(){var e=new Date(this);e.setDate(1);return e};Date.prototype._val=function(){this._clear();return{year:this.getFullYear(),month:this.getMonth(),date:this.getDate(),time:this.getTime(),day:this.getDay()}};Array.prototype._indexOf=function(e){return $.inArray(e,this)}})()})(jQuery)
